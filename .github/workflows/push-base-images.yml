name: Push Base Images

on:
  push:
    branches:
      - main
    paths:
      - 'docker/base/**'
  workflow_dispatch:
    inputs:
      images:
        description: 'Images to rebuild (comma-separated: golang-bookworm,golang-alpine,alpine,debian-slim,node-alpine,python — or leave blank for all)'
        required: false
        default: 'all'

env:
  REGISTRY: rapidaai

jobs:
  # ── Detect which base Dockerfiles changed ──────────────────────────────────
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      golang-bookworm: ${{ steps.set.outputs.golang-bookworm }}
      golang-alpine:   ${{ steps.set.outputs.golang-alpine }}
      alpine:          ${{ steps.set.outputs.alpine }}
      debian-slim:     ${{ steps.set.outputs.debian-slim }}
      node-alpine:     ${{ steps.set.outputs.node-alpine }}
      python:          ${{ steps.set.outputs.python }}
    steps:
      - uses: actions/checkout@v4

      - name: Path filter (push only)
        uses: dorny/paths-filter@v3
        id: filter
        if: github.event_name == 'push'
        with:
          filters: |
            golang-bookworm:
              - 'docker/base/rapida-golang-bookworm.Dockerfile'
            golang-alpine:
              - 'docker/base/rapida-golang-alpine.Dockerfile'
            alpine:
              - 'docker/base/rapida-alpine.Dockerfile'
            debian-slim:
              - 'docker/base/rapida-debian-slim.Dockerfile'
            node-alpine:
              - 'docker/base/rapida-node-alpine.Dockerfile'
            python:
              - 'docker/base/rapida-python.Dockerfile'

      - name: Set rebuild targets
        id: set
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            INPUT="${{ inputs.images }}"
            if [ "$INPUT" = "all" ] || [ -z "$INPUT" ]; then
              REBUILD_ALL=true
            else
              REBUILD_ALL=false
            fi
            rebuild() {
              local name="$1"
              if [ "$REBUILD_ALL" = "true" ] || echo "$INPUT" | grep -qw "$name"; then
                echo "${name}=true" >> "$GITHUB_OUTPUT"
              else
                echo "${name}=false" >> "$GITHUB_OUTPUT"
              fi
            }
            rebuild golang-bookworm
            rebuild golang-alpine
            rebuild alpine
            rebuild debian-slim
            rebuild node-alpine
            rebuild python
          else
            echo "golang-bookworm=${{ steps.filter.outputs.golang-bookworm }}" >> "$GITHUB_OUTPUT"
            echo "golang-alpine=${{ steps.filter.outputs.golang-alpine }}"     >> "$GITHUB_OUTPUT"
            echo "alpine=${{ steps.filter.outputs.alpine }}"                   >> "$GITHUB_OUTPUT"
            echo "debian-slim=${{ steps.filter.outputs.debian-slim }}"         >> "$GITHUB_OUTPUT"
            echo "node-alpine=${{ steps.filter.outputs.node-alpine }}"         >> "$GITHUB_OUTPUT"
            echo "python=${{ steps.filter.outputs.python }}"                   >> "$GITHUB_OUTPUT"
          fi

  # ── Shared login step (reused via composite would be ideal, but keeping it inline) ──

  # ── rapidaai/rapida-golang:1.25.7-bookworm (heavy — ONNX, RNNoise, Azure Speech SDK) ──
  push-golang-bookworm:
    name: Push rapida-golang:1.25.7-bookworm
    needs: changes
    if: needs.changes.outputs.golang-bookworm == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/base/rapida-golang-bookworm.Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/rapida-golang:1.25.7-bookworm
          cache-from: type=gha,scope=rapida-golang-bookworm
          cache-to: type=gha,scope=rapida-golang-bookworm,mode=max

  # ── rapidaai/rapida-golang:1.25.7-alpine ──────────────────────────────────
  push-golang-alpine:
    name: Push rapida-golang:1.25.7-alpine
    needs: changes
    if: needs.changes.outputs.golang-alpine == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/base/rapida-golang-alpine.Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/rapida-golang:1.25.7-alpine
          cache-from: type=gha,scope=rapida-golang-alpine
          cache-to: type=gha,scope=rapida-golang-alpine,mode=max

  # ── rapidaai/rapida-alpine:3.21 ───────────────────────────────────────────
  push-alpine:
    name: Push rapida-alpine:3.21
    needs: changes
    if: needs.changes.outputs.alpine == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/base/rapida-alpine.Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/rapida-alpine:3.21
          cache-from: type=gha,scope=rapida-alpine
          cache-to: type=gha,scope=rapida-alpine,mode=max

  # ── rapidaai/rapida-debian:bookworm-slim ──────────────────────────────────
  push-debian-slim:
    name: Push rapida-debian:bookworm-slim
    needs: changes
    if: needs.changes.outputs.debian-slim == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/base/rapida-debian-slim.Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/rapida-debian:bookworm-slim
          cache-from: type=gha,scope=rapida-debian-slim
          cache-to: type=gha,scope=rapida-debian-slim,mode=max

  # ── rapidaai/rapida-node:22-alpine ────────────────────────────────────────
  push-node-alpine:
    name: Push rapida-node:22-alpine
    needs: changes
    if: needs.changes.outputs.node-alpine == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/base/rapida-node-alpine.Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/rapida-node:22-alpine
          cache-from: type=gha,scope=rapida-node-alpine
          cache-to: type=gha,scope=rapida-node-alpine,mode=max

  # ── rapidaai/rapida-python:3.11 ───────────────────────────────────────────
  push-python:
    name: Push rapida-python:3.11
    needs: changes
    if: needs.changes.outputs.python == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/base/rapida-python.Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/rapida-python:3.11
          cache-from: type=gha,scope=rapida-python
          cache-to: type=gha,scope=rapida-python,mode=max

  # ── Summary ───────────────────────────────────────────────────────────────
  summary:
    name: Summary
    runs-on: ubuntu-latest
    if: always()
    needs:
      - push-golang-bookworm
      - push-golang-alpine
      - push-alpine
      - push-debian-slim
      - push-node-alpine
      - push-python
    steps:
      - name: Write summary
        run: |
          {
            echo "## Base Images ${{ job.status == 'success' && '✅' || '⚠️' }}"
            echo ""
            echo "| Image | Result |"
            echo "|-------|--------|"
            echo "| \`rapidaai/rapida-golang:1.25.7-bookworm\` | ${{ needs.push-golang-bookworm.result }} |"
            echo "| \`rapidaai/rapida-golang:1.25.7-alpine\`   | ${{ needs.push-golang-alpine.result }} |"
            echo "| \`rapidaai/rapida-alpine:3.21\`            | ${{ needs.push-alpine.result }} |"
            echo "| \`rapidaai/rapida-debian:bookworm-slim\`   | ${{ needs.push-debian-slim.result }} |"
            echo "| \`rapidaai/rapida-node:22-alpine\`         | ${{ needs.push-node-alpine.result }} |"
            echo "| \`rapidaai/rapida-python:3.11\`            | ${{ needs.push-python.result }} |"
          } >> "$GITHUB_STEP_SUMMARY"
